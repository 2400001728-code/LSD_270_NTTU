<!doctype html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Web tr·∫Øc nghi·ªám JSON</title>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-3BC3V1GYKX"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-3BC3V1GYKX");
        </script>

        <style>
            /* N√öT M·ªû SIDEBAR (ch·ªâ mobile) */
            .open-sidebar {
                display: none;
            }

            @media (max-width: 600px) {
                .open-sidebar {
                    display: block;
                    position: fixed;
                    bottom: 90px;
                    right: 16px;
                    z-index: 2000;
                    padding: 0.7rem 1rem;
                    border-radius: 999px;
                    border: none;
                    background: var(--primary);
                    color: #fff;
                    font-weight: 700;
                    box-shadow: var(--shadow);
                }

                .sidebar {
                    position: fixed;
                    left: 0;
                    right: 0;
                    bottom: -100%;
                    top: auto;
                    height: 70vh;
                    z-index: 1500;
                    border-radius: 18px 18px 0 0;
                    transition: 0.3s ease;
                    overflow-y: auto;
                }

                .sidebar.show {
                    bottom: 0;
                }
            }

            :root {
                --primary: #2563eb;
                --success: #16a34a;
                --danger: #dc2626;
                --bg: #f1f5f9;
                --card: #ffffff;
                --text: #0f172a;
                --muted: #4b5563;
                --border: #e2e8f0;
                --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            }

            /* Dark theme variables */
            .dark {
                --primary: #7aa8ff;
                --success: #34d399;
                --danger: #fca5a5;
                --bg: #0b1220;
                --card: #0f172a;
                --text: #e5e7eb;
                --muted: #cbd5e1;
                --border: #1f2937;
                --shadow: 0 10px 25px rgba(0, 0, 0, 0.45);
            }

            body {
                margin: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto;
                background: var(--bg);
                color: var(--text);
            }

            /* ===== HEADER ===== */
            header {
                background: linear-gradient(135deg, #2563eb, #1e40af);
                color: #fff;
                padding: 1rem 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: var(--shadow);
            }

            header b {
                font-size: 1.2rem;
            }

            /* ===== BUTTON ===== */
            .btn {
                padding: 0.55rem 1rem;
                border: none;
                border-radius: 999px;
                cursor: pointer;
                font-weight: 600;
                background: #fff;
                color: #1e40af;
            }

            .btn:hover {
                opacity: 0.9;
            }

            /* ===== HEADER ACTIONS ===== */
            .header-actions {
                display: flex;
                gap: 0.6rem;
            }

            /* N√∫t b·∫Øt ƒë·∫ßu */
            .btn.start {
                background: #ffffff;
                color: #1e40af;
            }

            /* N√∫t l√†m l·∫°i */
            .btn.reset {
                background: #fffbeb;
                color: #b45309;
                border: 2px solid #f59e0b;
            }

            /* N√∫t ch·∫ø ƒë·ªô */
            .btn.mode {
                background: #ecfeff;
                color: #155e75;
                border: 2px solid #06b6d4;
            }

            /* N√∫t theme */
            .btn.theme {
                background: #0f172a;
                color: #e2e8f0;
                border: 2px solid #1e293b;
            }

            .btn.theme:hover {
                background: #1e293b;
            }

            .btn.mode:hover {
                background: #cffafe;
            }

            .btn.reset:hover {
                background: #fef3c7;
            }

            /* ===== LAYOUT ===== */
            .app {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 1rem;
                padding: 1.5rem;
                max-width: 1200px;
                margin: auto;
            }

            @media (max-width: 900px) {
                .app {
                    grid-template-columns: 1fr;
                    padding: 1rem;
                }
            }

            @media (max-width: 600px) {
                body {
                    font-size: 15px;
                }
                header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.6rem;
                    padding: 0.9rem 1rem;
                }
                .header-actions {
                    width: 100%;
                    flex-wrap: wrap;
                    gap: 0.5rem;
                }
                .header-actions .btn {
                    flex: 1 1 calc(50% - 0.5rem);
                    text-align: center;
                }
            }

            /* ===== QUIZ CARD ===== */
            .card {
                background: var(--card);
                border-radius: 16px;
                padding: 2rem;
                box-shadow: var(--shadow);
                animation: fade 0.3s ease;
            }

            @media (max-width: 600px) {
                .card {
                    padding: 1.2rem 1rem;
                }
                .card p {
                    font-size: 1rem;
                    line-height: 1.45;
                }
            }

            @keyframes fade {
                from {
                    opacity: 0;
                    transform: translateY(6px);
                }

                to {
                    opacity: 1;
                }
            }

            .card b {
                font-size: 1.1rem;
                color: var(--primary);
            }

            .card p {
                font-size: 1.05rem;
                line-height: 1.6;
                margin: 1rem 0 1.5rem;
            }

            /* ===== OPTIONS ===== */
            .option {
                border: 2px solid var(--border);
                padding: 1rem 1.1rem;
                border-radius: 14px;
                margin-bottom: 1rem;
                cursor: pointer;
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
                transition: 0.2s;
                background: var(--card);
            }

            @media (max-width: 600px) {
                .option {
                    padding: 0.9rem;
                    gap: 0.6rem;
                }
                .option b {
                    min-width: 26px;
                    height: 26px;
                }
            }

            .option:hover {
                border-color: var(--primary);
                background: color-mix(in srgb, var(--primary) 10%, var(--card));
            }

            .option b {
                width: 28px;
                height: 28px;
                background: var(--border);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* ===== RESULT ===== */
            .option.correct {
                border-color: var(--success);
                background: rgba(22, 163, 74, 0.08);
            }

            .option.wrong {
                border-color: var(--danger);
                background: rgba(220, 38, 38, 0.08);
            }

            /* ===== SIDEBAR ===== */
            .sidebar {
                background: var(--card);
                border-radius: 18px;
                padding: 1.2rem 1rem;
                box-shadow: var(--shadow);
                height: fit-content;
                position: sticky;
                top: 1.5rem;
            }

            .sidebar b {
                display: block;
                margin-bottom: 1rem;
                font-size: 0.95rem;
                color: var(--muted);
                text-transform: uppercase;
                letter-spacing: 0.04em;
            }
            @media (max-width: 600px) {
                .sidebar {
                    display: none;
                }

                .sidebar.show {
                    display: block;
                }
            }

            /* ===== GRID C√ÇU H·ªéI ===== */
            #palette {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 0.6rem;
            }

            /* ===== N√öT C√ÇU ===== */
            .q-dot {
                height: 42px;
                border-radius: 12px;
                border: 2px solid var(--border);
                background: var(--card);
                cursor: pointer;
                font-weight: 700;
                color: var(--text);
                transition: 0.15s;
            }

            /* Hover */
            .q-dot:hover {
                border-color: var(--primary);
                background: color-mix(in srgb, var(--primary) 10%, var(--card));
            }

            /* ƒêang l√†m */
            .q-dot.active {
                border-color: var(--primary);
                background: #dbeafe;
                color: #1e40af;
            }

            /* ƒê√£ tr·∫£ l·ªùi */
            .q-dot.answered {
                background: #e2e8f0;
                border-color: #cbd5e1;
                color: #475569;
            }

            /* ===== SIDEBAR ƒê√öNG / SAI ===== */
            .q-dot.correct {
                background: rgba(22, 163, 74, 0.15);
                border-color: var(--success);
                color: #166534;
            }

            .q-dot.wrong {
                background: rgba(220, 38, 38, 0.15);
                border-color: var(--danger);
                color: #991b1b;
            }

            /* ƒê√£ tr·∫£ l·ªùi & ƒëang xem */
            .q-dot.answered.active {
                background: #bfdbfe;
                border-color: var(--primary);
                color: #1e40af;
            }

            /* ===== MOBILE ===== */
            @media (max-width: 900px) and (min-width: 601px) {
                .sidebar {
                    position: static;
                    margin-top: 1rem;
                }

                #palette {
                    grid-template-columns: repeat(6, 1fr);
                }
            }

            @media (max-width: 600px) {
                #palette {
                    grid-template-columns: repeat(5, 1fr);
                }
                .q-dot {
                    height: 38px;
                    border-radius: 10px;
                }
            }

            /* ===== FOOTER ===== */
            /* ===== FOOTER NAV ===== */
            .footer {
                max-width: 1200px;
                margin: 1rem auto 1.5rem;
                background: var(--card);
                border-radius: 18px;
                padding: 0.75rem 1rem;
                box-shadow: var(--shadow);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.5rem;
            }

            /* N√∫t ƒëi·ªÅu h∆∞·ªõng */
            .nav-btn {
                padding: 0.55rem 1.1rem;
                border-radius: 999px;
                border: 2px solid var(--border);
                background: var(--card);
                cursor: pointer;
                font-weight: 700;
                color: var(--text);
                transition: 0.15s;
            }

            .nav-btn:hover {
                border-color: var(--primary);
                background: color-mix(in srgb, var(--primary) 10%, var(--card));
            }

            /* N√∫t ch√≠nh */
            .nav-btn.primary {
                background: var(--primary);
                border-color: var(--primary);
                color: #fff;
            }

            /* Trung t√¢m footer */
            .footer-center {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 700;
                color: var(--muted);
            }

            .footer-center .dot {
                opacity: 0.5;
            }

            /* Mobile */
            @media (max-width: 600px) {
                .footer {
                    flex-direction: column;
                    gap: 0.6rem;
                }

                .nav-btn {
                    width: 100%;
                }
            }

            /* ===== SCORE ===== */
            #score {
                color: var(--primary);
            }

            .sidebar-nav {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.6rem;
                margin-top: 1rem;
                font-weight: 700;
                color: var(--muted);
            }
        </style>
    </head>

    <body>
        <header>
            <b>Web tr·∫Øc nghi·ªám</b>

            <div class="header-actions">
                <button class="btn start" onclick="start()">‚ñ∂ B·∫Øt ƒë·∫ßu (50)</button>
                <button class="btn mode" onclick="toggleMode()">üß† L√†m 270 c√¢u</button>
                <button class="btn theme" onclick="toggleTheme()" id="theme-btn">üåô Dark</button>
                <button class="btn reset" onclick="resetQuiz()">üîÑ L√†m l·∫°i</button>
            </div>
        </header>

        <div class="app">
            <div id="quiz"></div>
            <div class="sidebar">
                <b>C√¢u h·ªèi</b>
                <div id="palette"></div>
                <div class="sidebar-nav">
                    <button class="nav-btn" onclick="prevSidebar()">‚¨Ö</button>
                    <span id="sidebar-page"></span>
                    <button class="nav-btn" onclick="nextSidebar()">‚û°</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <button class="nav-btn" onclick="prevQuestion()">‚¨Ö C√¢u tr∆∞·ªõc</button>

            <div class="footer-center">
                <span id="progress-text">C√¢u 1 / 50</span>
                <span class="dot">‚Ä¢</span>
                <span id="score">ƒê√∫ng 0</span>
            </div>

            <button class="nav-btn primary" onclick="nextQuestion()">C√¢u sau ‚û°</button>
        </div>

        <div style="max-width: 1200px; margin: 0 auto 1rem; padding: 0 1.5rem; color: var(--muted); font-weight: 600;">
            üë• Ng∆∞·ªùi ƒëang online: <span id="onlineCount">0</span>
        </div>

        <script>
            let SIDEBAR_PAGE = 0;
            const SIDEBAR_SIZE = 50;
            const SESSION_SIZE = 50;
            let MODE = 50;
            let THEME = "light";
            const THEME_KEY = "quiz-theme";
            let questions = [],
                answers = {},
                correctKey = {},
                active = [],
                idx = 0;

            // LOAD QUESTIONS
            fetch("tracnghiem-questions.json")
                .then((r) => r.json())
                .then((d) => {
                    questions = d.questions;
                });

            // LOAD ANSWERS
            fetch("dapan.json")
                .then((r) => r.json())
                .then((d) => {
                    d.questions.forEach((q) => {
                        correctKey[q.number] = q.answer;
                    });
                });

            // THEME
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme) {
                THEME = savedTheme;
                applyTheme();
            }

            function start() {
                answers = {};

                if (MODE === 270) {
                    active = [...questions]; // l·∫•y to√†n b·ªô
                } else {
                    active = [...questions].sort(() => Math.random() - 0.5).slice(0, SESSION_SIZE);
                }

                buildPalette();
                render(0);

                document.getElementById("progress-text").textContent = `C√¢u 1 / ${active.length}`;
            }
            function updateSidebarPage() {
                const total = Math.ceil(active.length / SIDEBAR_SIZE);
                document.getElementById("sidebar-page").textContent = `${SIDEBAR_PAGE + 1} / ${total}`;
            }

            function prevSidebar() {
                if (SIDEBAR_PAGE > 0) {
                    SIDEBAR_PAGE--;
                    buildPalette();
                    updateSidebarPage();
                }
            }

            function nextSidebar() {
                const total = Math.ceil(active.length / SIDEBAR_SIZE);
                if (SIDEBAR_PAGE < total - 1) {
                    SIDEBAR_PAGE++;
                    buildPalette();
                    updateSidebarPage();
                }
            }

            function toggleMode() {
                if (MODE === 50) {
                    if (!confirm("Chuy·ªÉn sang l√†m to√†n b·ªô 270 c√¢u?")) return;
                    MODE = 270;
                    document.querySelector(".btn.mode").textContent = "‚ö° L√†m 50 c√¢u";
                } else {
                    if (!confirm("Quay l·∫°i ch·∫ø ƒë·ªô 50 c√¢u ng·∫´u nhi√™n?")) return;
                    MODE = 50;
                    document.querySelector(".btn.mode").textContent = "üß† L√†m 270 c√¢u";
                }

                start();
            }

            function buildPalette() {
                const p = document.getElementById("palette");
                p.innerHTML = "";

                const start = SIDEBAR_PAGE * SIDEBAR_SIZE;
                const end = Math.min(start + SIDEBAR_SIZE, active.length);

                for (let i = start; i < end; i++) {
                    const b = document.createElement("button");
                    b.className = "q-dot";
                    b.textContent = i + 1;

                    // üîë L∆ØU INDEX TO√ÄN C·ª§C
                    b.dataset.index = i;

                    b.onclick = () => render(i);

                    const qNum = active[i].number;

                    if (answers[qNum]) {
                        b.classList.add("answered");

                        if (answers[qNum] === correctKey[qNum]) {
                            b.classList.add("correct");
                        } else {
                            b.classList.add("wrong");
                        }
                    }

                    if (i === idx) {
                        b.classList.add("active");
                    }

                    p.appendChild(b);
                }

                updateSidebarPage();
            }

            function render(i) {
                document.querySelector(".sidebar")?.classList.remove("show");
                SIDEBAR_PAGE = Math.floor(i / SIDEBAR_SIZE);
                idx = i;
                const q = active[i];
                const realAnswer = correctKey[q.number];
                const quiz = document.getElementById("quiz");

                quiz.innerHTML = `
            <div class="card">
                 <b>C√¢u ${q.number}</b>
                 <p>${q.text}</p>
                 ${Object.entries(q.options)
                     .map(
                         ([k, v]) => `
                  <div class="option" data-k="${k}">
                         <b>${k}</b>. ${v}
                    </div>`
                     )
                     .join("")}
             </div>
                     `;

                quiz.querySelectorAll(".option").forEach((o) => {
                    o.onclick = () => {
                        if (answers[q.number]) return;
                        answers[q.number] = o.dataset.k;

                        // N·∫øu ch∆∞a c√≥ ƒë√°p √°n (dapan.json kh√¥ng kh·ªõp), v·∫´n cho l√†m b√†i nh∆∞ng kh√¥ng t√¥ ƒë√∫ng/sai
                        if (realAnswer) {
                            quiz.querySelectorAll(".option").forEach((x) => {
                                if (x.dataset.k === realAnswer) x.classList.add("correct");
                                else if (x.dataset.k === o.dataset.k) x.classList.add("wrong");
                            });
                        }

                        const dot = document.querySelector(`.q-dot[data-index="${i}"]`);
                        if (!dot) return;

                        dot.classList.add("answered");
                        if (realAnswer) {
                            if (answers[q.number] === realAnswer) {
                                dot.classList.add("correct");
                                dot.classList.remove("wrong");
                            } else {
                                dot.classList.add("wrong");
                                dot.classList.remove("correct");
                            }
                        }

                        updateScore();
                    };
                });

                document.getElementById("progress-text").textContent = `C√¢u ${i + 1} / ${active.length}`;
                // ===== KH√îI PH·ª§C M√ÄU ƒê√öNG / SAI KHI QUAY L·∫†I =====
                if (answers[q.number] && realAnswer) {
                    const chosen = answers[q.number];

                    quiz.querySelectorAll(".option").forEach((o) => {
                        if (o.dataset.k === realAnswer) {
                            o.classList.add("correct");
                        } else if (o.dataset.k === chosen) {
                            o.classList.add("wrong");
                        }
                    });
                }
                buildPalette();
            }

            function updateScore() {
                let c = 0;
                for (let n in answers) {
                    if (correctKey[n] && answers[n] === correctKey[n]) c++;
                }
                document.getElementById("score").textContent = "ƒê√∫ng " + c;
            }
            function prevQuestion() {
                if (idx > 0) render(idx - 1);
            }

            function nextQuestion() {
                if (idx < active.length - 1) render(idx + 1);
            }
            function resetQuiz() {
                if (!confirm("L√†m l·∫°i s·∫Ω ƒë·ªïi to√†n b·ªô c√¢u h·ªèi. B·∫°n ch·∫Øc ch·∫Øn kh√¥ng?")) return;

                // X√≥a ƒë√°p √°n
                answers = {};

                // Reset tr·∫°ng th√°i ƒëi·ªÅu h∆∞·ªõng
                SIDEBAR_PAGE = 0;
                idx = 0;

                // Gi·ªØ ƒë√∫ng ch·∫ø ƒë·ªô hi·ªán t·∫°i (50 hay 270)
                if (MODE === 270) {
                    active = [...questions]; // to√†n b·ªô 270 c√¢u
                } else {
                    active = [...questions].sort(() => Math.random() - 0.5).slice(0, SESSION_SIZE); // 50 c√¢u ng·∫´u nhi√™n
                }

                document.getElementById("score").textContent = "ƒê√∫ng 0";
                document.getElementById("progress-text").textContent = `C√¢u 1 / ${active.length}`;

                buildPalette();
                render(0);
            }
            function toggleSidebar() {
                document.querySelector(".sidebar").classList.toggle("show");
            }

            function applyTheme() {
                const root = document.documentElement;
                if (THEME === "dark") {
                    root.classList.add("dark");
                    document.getElementById("theme-btn").textContent = "‚òÄ Light";
                } else {
                    root.classList.remove("dark");
                    document.getElementById("theme-btn").textContent = "üåô Dark";
                }
                localStorage.setItem(THEME_KEY, THEME);
            }

            function toggleTheme() {
                THEME = THEME === "dark" ? "light" : "dark";
                applyTheme();
            }
        </script>
        <button class="open-sidebar" onclick="toggleSidebar()">üìã C√¢u h·ªèi</button>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
            import {
                getDatabase,
                ref,
                set,
                onValue,
                onDisconnect,
            } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyAvUX94URWIom04aDsPSnKd97G1PLEcn1Y",
                authDomain: "lsd270nttu.firebaseapp.com",
                databaseURL: "https://lsd270nttu-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "lsd270nttu",
                storageBucket: "lsd270nttu.firebasestorage.app",
                messagingSenderId: "43909484510",
                appId: "1:43909484510:web:703fd6c6a25477a0eb574f",
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const userId = Date.now() + "_" + Math.random().toString(36).slice(2);
            const userRef = ref(db, "onlineUsers/" + userId);

            set(userRef, true);
            onDisconnect(userRef).remove();

            const countRef = ref(db, "onlineUsers");
            onValue(countRef, (snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                const el = document.getElementById("onlineCount");
                if (el) el.innerText = count;
            });
        </script>
    </body>
</html>
